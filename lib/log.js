"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_extends2=require("babel-runtime/helpers/extends"),_extends3=_interopRequireDefault(_extends2),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),appStart=new Date,Log=function(){function e(){(0,_classCallCheck3.default)(this,e),this.bus=new Bus}return(0,_createClass3.default)(e,[{key:"with",value:function(e){return new LogActivity(this.bus).with(e)}},{key:"note",value:function(e){return new LogActivity(this.bus).note(e)}},{key:"enter",value:function(e,t){return new LogActivity(this.bus).enter(e,t)}},{key:"subscribe",value:function(e){return this.bus.subscribe(e)}}]),e}();exports.default=Log;var LogActivity=function(){function e(t){(0,_classCallCheck3.default)(this,e),this.extensions={},this.entries=[],this.publisher=t}return(0,_createClass3.default)(e,[{key:"exit",value:function(e){if(this.complete)throw new Error("Exiting an unentered activity");this.complete=!0;var t=this.entries[0],i=new LogEntry(e||"exiting activity",t.method);i.entries=this.entries,i.startTime=t.time,i.exiting=!0,i.stopTime=new Date,this.publish(i)}},{key:"note",value:function e(t){if(this.complete)throw new Error("Note called on a completed activity");var e=new LogEntry(t);return this.publish((0,_extends3.default)({},e,this.extensions))}},{key:"with",value:function(e){return e&&(this.extensions=(0,_extends3.default)({},this.extensions,e)),this}},{key:"enter",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments[1];this.name=e;var i=new LogEntry(("entering activity "+this.name).trim());if(i.entering=!0,this.publish(i),!t)return this.enter=void 0,this;try{t(this),this.exit()}catch(e){throw this.exit(e),e}return null}},{key:"publish",value:function(e){var t=(0,_extends3.default)({},e.copy(),this.extensions);return this.entries.push(t),this.publisher.publish(t),e}}]),e}(),LogEntry=function e(t){var i=this;(0,_classCallCheck3.default)(this,e),this.addNote=function(e){e&&("string"==typeof e?i.message=e:e instanceof Error?i.error=e:(0,_assign2.default)(i,e))},this.stack=function(){return stack({e:i.error})},this.copy=function(){return(0,_extends3.default)({},new e(null),i,{clone:!0})},this.appStart=function(){return appStart},this.appElapsed=function(){return i.time-appStart},this.elapsed=function(){return Math.max(0,i.time-i.startTime)},this.time=new Date,this.addNote(t)},Bus=function(){function e(){(0,_classCallCheck3.default)(this,e),this.subscriptions=[]}return(0,_createClass3.default)(e,[{key:"subscribe",value:function(e){return this.when().subscribe(e)}},{key:"when",value:function(e){var t=this;return{subscribe:function(i){function s(t){e&&!e(t)||i(t)}return t.subscriptions.push(s),{unsubscribe:function(){t.subscriptions=t.subscriptions.filter(function(e){return e!==s})}}}}}},{key:"publish",value:function(e){this.subscriptions.forEach(function(t){try{t(e)}catch(e){}})}}]),e}();module.exports=exports.default;
//# sourceMappingURL=maps/log.js.map
