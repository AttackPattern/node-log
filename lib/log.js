"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_extends2=require("babel-runtime/helpers/extends"),_extends3=_interopRequireDefault(_extends2),_classCallCheck2=require("babel-runtime/helpers/classCallCheck"),_classCallCheck3=_interopRequireDefault(_classCallCheck2),_createClass2=require("babel-runtime/helpers/createClass"),_createClass3=_interopRequireDefault(_createClass2),appStart=new Date,Log=function(){function t(){var e=this;(0,_classCallCheck3.default)(this,t),this.bus=new Bus,this.note=function(t){return new LogActivity(e.bus).note(t)},this.enter=function(t){return new LogActivity(e.bus).enter(t)}}return(0,_createClass3.default)(t,[{key:"with",value:function(t){return new LogActivity(this.bus).with(t)}},{key:"subscribe",value:function(t){return this.bus.subscribe(t)}}]),t}();exports.default=Log;var LogActivity=function(){function t(e){(0,_classCallCheck3.default)(this,t),this.extensions={},this.entries=[],this.active=!0,this.publisher=e}return(0,_createClass3.default)(t,[{key:"publish",value:function(t){var e=(0,_extends3.default)({},t.copy(),this.extensions);return this.entries.push(e),this.publisher.publish(e),t}},{key:"exit",value:function(t){this.active=!1;var e=this.entries[0],i=new LogEntry(t||"exiting activity",e.method);i.entries=this.entries,i.startTime=e.time,i.exiting=!0,i.stopTime=new Date,this.publish(i)}},{key:"note",value:function t(e,i){if(!this.active)throw new Error("Note called on a completed activity");var t=new LogEntry(e,i);return this.publish((0,_extends3.default)({},t,this.extensions))}},{key:"with",value:function(t){return t&&(this.extensions=(0,_extends3.default)({},this.extensions,t)),this}},{key:"enter",value:function(t,e){var i=new LogEntry("entering activity",e||this.enter.caller);if(i.entering=!0,this.publish(i),this.exit=exit,!t)return this.enter=void 0,this;try{t(this),this.exit()}catch(t){throw this.exit(t),t}return null}}]),t}(),LogEntry=function t(e,i){(0,_classCallCheck3.default)(this,t),_initialiseProps.call(this),this.time=new Date,this.addNote(e),this.addArguments(i)},_initialiseProps=function(){var t=this;this.addNote=function(e){e&&("string"==typeof e?t.message=e:e instanceof Error?t.error=e:t.subject=e)},this.addArguments=function(e){try{if(e.arguments){var i=Array.prototype.slice.call(e.arguments);(0,_stringify2.default)(i),t.arguments=i}}catch(e){t.arguments="Cyclic arguments"}},this.stack=function(){return stack({e:t.error})},this.copy=function(){return(0,_extends3.default)({},new LogEntry(null,t.method),t,{clone:!0})},this.appStart=function(){return appStart},this.appElapsed=function(){return t.time-appStart},this.elapsed=function(){return Math.max(0,t.time-t.startTime)}},Bus=function(){function t(){(0,_classCallCheck3.default)(this,t),this.subscriptions=[]}return(0,_createClass3.default)(t,[{key:"subscribe",value:function(t){return this.when().subscribe(t)}},{key:"when",value:function(t){var e=this;return{subscribe:function(i){function s(e){t&&!t(e)||i(e)}return e.subscriptions.push(s),{unsubscribe:function(){e.subscriptions=e.subscriptions.filter(function(t){return t!==s})}}}}}},{key:"publish",value:function(t){this.subscriptions.forEach(function(e){try{e(t)}catch(t){}})}}]),t}();module.exports=exports.default;
//# sourceMappingURL=maps/log.js.map
