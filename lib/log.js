"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _cleanStack=_interopRequireDefault(require("clean-stack"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),i.forEach(function(e){_defineProperty(t,e,n[e])})}return t}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var appStart=new Date,Log=function(){function e(){_classCallCheck(this,e),_defineProperty(this,"bus",new Bus)}return _createClass(e,[{key:"with",value:function(e){return new LogActivity(this.bus).with(e)}},{key:"note",value:function(e){return new LogActivity(this.bus).note(e)}},{key:"enter",value:function(e,t){return new LogActivity(this.bus).enter(e,t)}},{key:"subscribe",value:function(e){return this.bus.subscribe(e)}}]),e}();exports.default=Log;var LogActivity=function(){function t(e){_classCallCheck(this,t),_defineProperty(this,"extensions",{}),_defineProperty(this,"entries",[]),this.publisher=e}return _createClass(t,[{key:"exit",value:function(e){if(this.complete)throw new Error("Exiting an unentered activity");this.complete=!0;var t=this.entries[0],n=new LogEntry(e||"exiting activity",t.method);n.entries=this.entries,n.startTime=t.time,n.exiting=!0,n.stopTime=new Date,this.publish(n)}},{key:"note",value:function(e){if(this.complete)throw new Error("Note called on a completed activity");var t=new LogEntry(e);return this.publish(_objectSpread({},t,this.extensions))}},{key:"with",value:function(e){return e&&(this.extensions=_objectSpread({},this.extensions,e)),this}},{key:"enter",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",t=1<arguments.length?arguments[1]:void 0;this.name=e;var n=new LogEntry("entering activity ".concat(this.name).trim());if(n.entering=!0,this.publish(n),!t)return this.enter=void 0,this;try{t(this),this.exit()}catch(e){throw this.exit(e),e}return null}},{key:"publish",value:function(e){var t=_objectSpread({},e.copy(),this.extensions);return this.entries.push(t),this.publisher.publish(t),e}}]),t}(),LogEntry=function e(t){var n=this;_classCallCheck(this,e),_defineProperty(this,"addNote",function(e){e&&("string"==typeof e?n.message=e:e instanceof Error?n.error=e:Object.assign(n,e))}),_defineProperty(this,"stack",function(){var e;return(0,_cleanStack.default)(null===(e=n.error)||void 0===e?void 0:e.stack)}),_defineProperty(this,"copy",function(){return _objectSpread({},new e(null),n)}),_defineProperty(this,"appStart",function(){return appStart}),_defineProperty(this,"appElapsed",function(){return n.time-appStart}),_defineProperty(this,"elapsed",function(){return Math.max(0,n.time-n.startTime)}),this.time=new Date,this.addNote(t)},Bus=function(){function e(){_classCallCheck(this,e),_defineProperty(this,"subscriptions",[])}return _createClass(e,[{key:"subscribe",value:function(e){return this.when().subscribe(e)}},{key:"when",value:function(i){var e=this;return{subscribe:function(t){function n(e){i&&!i(e)||t(e)}return e.subscriptions.push(n),{unsubscribe:function(){e.subscriptions=e.subscriptions.filter(function(e){return e!==n})}}}}}},{key:"publish",value:function(t){this.subscriptions.forEach(function(e){try{e(t)}catch(e){}})}}]),e}();
//# sourceMappingURL=maps/log.js.map
