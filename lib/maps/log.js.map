{"version":3,"sources":["log.js"],"names":["_cleanStack","_interopRequireDefault","require","appStart","Date","Log","Bus","extension","LogActivity","this","bus","with","subject","note","name","section","enter","subscription","subscribe","publisher","_classCallCheck","_defineProperty","error","complete","Error","start","entries","entry","method","startTime","time","exiting","stopTime","publish","LogEntry","_objectSpread","extensions","arguments","length","undefined","concat","trim","entering","exit","e","publishEntry","copy","push","_this","Object","assign","_this$error","default","stack","clone","Math","max","addNote","callback","condition","_this2","sub","payload","subscriptions","unsubscribe","filter","next","forEach"],"mappings":"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","file":"../log.js","sourcesContent":["import stack from 'clean-stack';\n\nconst appStart = new Date();\n\nexport default class Log {\n  bus = new Bus();\n\n  with(extension) {\n    return new LogActivity(this.bus).with(extension);\n  }\n  note(subject) {\n    return new LogActivity(this.bus).note(subject);\n  }\n  enter(name, section) {\n    return new LogActivity(this.bus).enter(name, section);\n  }\n  subscribe(subscription) {\n    return this.bus.subscribe(subscription);\n  }\n}\n\nclass LogActivity {\n  extensions = {}\n  entries = []\n\n  constructor(publisher) {\n    this.publisher = publisher;\n  }\n\n  exit(error) {\n    if (this.complete) {\n      throw new Error('Exiting an unentered activity');\n    }\n    this.complete = true;\n    const start = this.entries[0];\n    const entry = new LogEntry(error || 'exiting activity', start.method);\n    entry.entries = this.entries;\n    entry.startTime = start.time;\n    entry.exiting = true;\n    entry.stopTime = new Date();\n\n    this.publish(entry);\n  }\n\n  note(subject) {\n    if (this.complete) {\n      throw new Error('Note called on a completed activity');\n    }\n    const note = new LogEntry(subject);\n    return this.publish({\n      ...note,\n      ...this.extensions\n    });\n  }\n\n  with(extension) {\n    if (extension) {\n      this.extensions = {\n        ...this.extensions,\n        ...extension\n      };\n    }\n    return this;\n  }\n\n  enter(name = '', section) {\n    this.name = name;\n    const entry = new LogEntry(`entering activity ${this.name}`.trim());\n    entry.entering = true;\n    this.publish(entry);\n\n    if (!section) {\n      this.enter = undefined;\n      return this;\n    }\n\n    try {\n      section(this);\n      this.exit();\n    }\n    catch (e) {\n      this.exit(e);\n      throw e;\n    }\n    return null;\n  }\n\n  publish(entry) {\n    let publishEntry = {\n      ...entry.copy(),\n      ...this.extensions\n    };\n    this.entries.push(publishEntry);\n    this.publisher.publish(publishEntry);\n    return entry;\n  }\n}\n\n\nclass LogEntry {\n  constructor(subject) {\n    this.time = new Date();\n    this.addNote(subject);\n  }\n\n  addNote = note => {\n    if (!note) {\n      return;\n    }\n    if (typeof note === 'string') {\n      this.message = note;\n    }\n    else if (note instanceof Error) {\n      this.error = note;\n    }\n    else {\n      Object.assign(this, note);\n    }\n  }\n\n  stack = () => {\n    return stack(this.error?.stack);\n  }\n\n  copy = () => ({\n    ...new LogEntry(null),\n    ...this,\n    clone: true\n  })\n  appStart = () => appStart\n  appElapsed = () => this.time - appStart\n  elapsed = () => Math.max(0, this.time - this.startTime)\n}\n\nclass Bus {\n  subscriptions = []\n  subscribe(callback) {\n    return this.when().subscribe(callback);\n  }\n  when(condition) {\n    return {\n      subscribe: callback => {\n        function sub(payload) {\n          if (!condition || condition(payload)) {\n            callback(payload);\n          }\n        }\n        this.subscriptions.push(sub);\n\n        return {\n          unsubscribe: () => {\n            this.subscriptions = this.subscriptions.filter(next => next !== sub);\n          }\n        };\n      }\n    };\n  }\n  publish(subject) {\n    this.subscriptions.forEach(sub => {\n      try {\n        sub(subject);\n      }\n      catch (e) {\n        // Honey badger\n      }\n    });\n  }\n}\n"]}